<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Asset EOL Dashboard v2.32</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        #error-box { display: none; }
        .sticky-filter { top: 76px; } 
    </style>

    <!-- 3. Libraries (JSDelivr) -->
    <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/recharts@2.10.3/umd/Recharts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.10/babel.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-900">
    
    <div id="error-box" class="fixed inset-0 bg-white z-50 flex items-center justify-center p-4">
        <div class="bg-red-50 border border-red-200 rounded-lg p-6 max-w-lg w-full shadow-lg">
            <h2 class="text-red-700 font-bold text-xl mb-2">เกิดข้อผิดพลาด (System Error)</h2>
            <div class="bg-white p-3 rounded border border-red-100 mb-4">
                <p id="error-message" class="text-red-600 font-mono text-sm break-words"></p>
            </div>
            <div class="text-sm text-slate-600 space-y-2">
                <p class="font-semibold">วิธีแก้ไขเบื้องต้น:</p>
                <ul class="list-disc pl-5 space-y-1">
                    <li>กด <b>Ctrl + F5</b> เพื่อล้าง Cache</li>
                </ul>
            </div>
        </div>
    </div>

    <div id="root" class="min-h-screen flex items-center justify-center">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-slate-500">กำลังโหลด Dashboard v2.32 (Added Pie Charts)...</p>
        </div>
    </div>

    <script>
        window.onerror = function(msg, url, line, col, error) {
            document.getElementById('error-box').style.display = 'flex';
            document.getElementById('error-message').textContent = msg + " (Line: " + line + ")";
            document.getElementById('root').style.display = 'none';
            return false;
        };
    </script>

    <script type="text/babel">
        try {
            if (!window.React || !window.ReactDOM || !window.Recharts) throw new Error("Libraries failed to load.");

            const { useState, useMemo, useEffect } = React;
            const { createRoot } = ReactDOM;
            const { 
                PieChart, Pie, Cell, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip: RechartsTooltip, Legend, ResponsiveContainer 
            } = window.Recharts;

            const Icons = {
                LayoutDashboard: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>,
                Upload: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
                AlertTriangle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>,
                Clock: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
                Server: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="20" height="8" x="2" y="2" rx="2" ry="2"/><rect width="20" height="8" x="2" y="14" rx="2" ry="2"/><line x1="6" x2="6.01" y1="6" y2="6"/><line x1="6" x2="6.01" y1="18" y2="18"/></svg>,
                Layers: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z"/><path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65"/><path d="m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65"/></svg>,
                Search: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
                Filter: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>,
                Trash2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
                FileSpreadsheet: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M8 13h2"/><path d="M14 13h2"/><path d="M8 17h2"/><path d="M14 17h2"/></svg>,
                Grid: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>,
                List: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>,
                Briefcase: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>,
                HardDrive: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="22" x2="2" y1="12" y2="12"/><path d="M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/><line x1="6" x2="6.01" y1="16" y2="16"/><line x1="10" x2="10.01" y1="16" y2="16"/></svg>,
                Box: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>,
                FileDown: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M12 18v-6"/><path d="m9 15 3 3 3-3"/></svg>,
                CheckCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
                XCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>,
                Eye: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8-11-8-11-8-11-8-11-8-11-8-11-8-11-8-11-8-11-8-11-8-11-8-11-8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
                HelpCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
            };

            const parseDate = (dateStr) => {
                if (!dateStr || dateStr === 'Not Announced' || dateStr.trim() === '') return null;
                const date = new Date(dateStr);
                return isNaN(date.getTime()) ? null : date;
            };

            const getStatus = (date) => {
                if (!date) return 'Unknown';
                const today = new Date();
                const diffTime = date - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays < 0) return 'Expired';
                if (diffDays <= 180) return 'Critical'; 
                if (diffDays <= 365) return 'Warning';  
                if (diffDays <= 730) return 'Watchlist';
                return 'Good';
            };

            const STATUS_CONFIG = {
                Expired: { color: 'text-red-700', bg: 'bg-red-50', border: 'border-red-200', icon: Icons.XCircle, iconColor: 'text-red-600', iconBg: 'bg-red-100' },
                Critical: { color: 'text-orange-700', bg: 'bg-orange-50', border: 'border-orange-200', icon: Icons.AlertTriangle, iconColor: 'text-orange-600', iconBg: 'bg-orange-100' },
                Warning: { color: 'text-yellow-700', bg: 'bg-yellow-50', border: 'border-yellow-200', icon: Icons.AlertTriangle, iconColor: 'text-yellow-600', iconBg: 'bg-yellow-100' },
                Watchlist: { color: 'text-blue-700', bg: 'bg-blue-50', border: 'border-blue-200', icon: Icons.Eye, iconColor: 'text-blue-600', iconBg: 'bg-blue-100' },
                Good: { color: 'text-green-700', bg: 'bg-green-50', border: 'border-green-200', icon: Icons.CheckCircle, iconColor: 'text-green-600', iconBg: 'bg-green-100' },
                Unknown: { color: 'text-slate-700', bg: 'bg-slate-50', border: 'border-slate-200', icon: Icons.HelpCircle, iconColor: 'text-slate-500', iconBg: 'bg-slate-200' },
            };

            const STATUS_LABELS = {
                Expired: 'Expired',
                Critical: '< 6 Months',
                Warning: '6 - 12 Months',
                Watchlist: '1 - 2 Years',
                Good: '> 2 Years',
                Unknown: 'Unknown'
            };
            
            const STATUS_ORDER = ['Expired', 'Critical', 'Warning', 'Watchlist', 'Good', 'Unknown'];
            
            // Pie Chart Colors
            const PIE_COLORS = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#6366F1', '#14B8A6', '#F472B6', '#64748B'];

            const TEMPLATE_HEADERS = `ProjectCode,Project Name,Vendor,Device Type,Product Type,Hostname,Part Number,SerialNumber,Version,Major Version,HW EOL Date,HW LDoS,SW EOL Date,SW LDoS`;

            const parseCSV = (text) => {
                const rows = [];
                let currentRow = [];
                let currentCell = '';
                let insideQuotes = false;
                const normalizedText = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

                for (let i = 0; i < normalizedText.length; i++) {
                    const char = normalizedText[i];
                    const nextChar = normalizedText[i + 1];
                    if (char === '"') {
                        if (insideQuotes && nextChar === '"') {
                            currentCell += '"'; i++;
                        } else { insideQuotes = !insideQuotes; }
                    } else if (char === ',' && !insideQuotes) {
                        currentRow.push(currentCell.trim()); currentCell = '';
                    } else if (char === '\n' && !insideQuotes) {
                        currentRow.push(currentCell.trim());
                        if (currentRow.length > 0 && (currentRow.length > 1 || currentRow[0] !== '')) {
                            rows.push(currentRow);
                        }
                        currentRow = []; currentCell = '';
                    } else { currentCell += char; }
                }
                if (currentCell || currentRow.length > 0) {
                    currentRow.push(currentCell.trim());
                    if (currentRow.length > 0 && (currentRow.length > 1 || currentRow[0] !== '')) {
                        rows.push(currentRow);
                    }
                }
                if (rows.length === 0) return [];
                const headers = rows[0].map(h => h.replace(/^"|"$/g, '').trim());
                return rows.slice(1).map(rowValues => {
                    const entry = {};
                    headers.forEach((header, index) => { entry[header] = rowValues[index] || ''; });
                    return entry;
                });
            };

            function StatusBox({ label, count, config }) {
                const Icon = config.icon;
                return (
                    <div className={`p-3 rounded-xl border ${config.bg} ${config.border} flex items-center gap-3 transition-all hover:shadow-md h-full`}>
                         <div className={`p-2.5 rounded-full flex-shrink-0 ${config.iconBg} ${config.iconColor}`}>
                             <Icon className="w-5 h-5" />
                        </div>
                        <div className="flex flex-col min-w-0">
                            <span className={`text-2xl font-bold leading-tight ${config.color}`}>{count}</span>
                            <span className={`text-[12px] font-bold uppercase tracking-wide opacity-80 truncate ${config.color}`}>{label}</span>
                        </div>
                    </div>
                );
            }

            function StatusBadge({ status, type }) {
                const config = STATUS_CONFIG[status] || STATUS_CONFIG.Unknown;
                return (
                    <span className={`inline-flex items-center px-2 py-0.5 rounded text-sm font-medium border ${config.bg} ${config.color} ${config.border}`}>
                        {type}: {STATUS_LABELS[status]}
                    </span>
                );
            }

            // --- Custom Label Renderers (Fix for Error 130) ---
            const renderBarLabelTop = (props) => {
                const { x, y, width, value } = props;
                if (!value) return null;
                return (
                    <text x={x + width / 2} y={y - 5} fill="#64748b" textAnchor="middle" fontSize={12} fontWeight="bold">
                        {value}
                    </text>
                );
            };

            const renderBarLabelRight = (props) => {
                const { x, y, width, height, value } = props;
                if (!value) return null;
                return (
                    <text x={x + width + 5} y={y + height / 2} fill="#64748b" textAnchor="start" dominantBaseline="middle" fontSize={12} fontWeight="bold">
                        {value}
                    </text>
                );
            };
            
            // Standard Recharts Label with percentage
            const renderPieLabel = (props) => {
                const { name, value, percent } = props;
                if (!value) return null;
                return `${value} (${(percent * 100).toFixed(0)}%)`;
            };

            function EOLDashboard() {
                const [rawData, setRawData] = useState([]);
                const [filteredData, setFilteredData] = useState([]);
                const [loading, setLoading] = useState(false);
                const [viewMode, setViewMode] = useState('standard');
                
                const [selectedVendor, setSelectedVendor] = useState('All');
                const [selectedProductType, setSelectedProductType] = useState('All');
                const [selectedHwStatus, setSelectedHwStatus] = useState('All');
                const [selectedSwStatus, setSelectedSwStatus] = useState('All');
                const [searchQuery, setSearchQuery] = useState('');

                const processData = (csvData) => {
                    return csvData.map(item => {
                        const hwDate = parseDate(item['HW EOL Date']);
                        const swDate = parseDate(item['SW EOL Date']);
                        return {
                            ...item,
                            hwDateObj: hwDate,
                            swDateObj: swDate,
                            hwStatus: getStatus(hwDate),
                            swStatus: getStatus(swDate),
                            id: item.SerialNumber || Math.random().toString(36).substr(2, 9)
                        };
                    });
                };

                useEffect(() => {
                    let result = rawData;
                    if (selectedVendor !== 'All') result = result.filter(item => item.Vendor === selectedVendor);
                    if (selectedProductType !== 'All') result = result.filter(item => item['Product Type'] === selectedProductType);
                    if (selectedHwStatus !== 'All') result = result.filter(item => item.hwStatus === selectedHwStatus);
                    if (selectedSwStatus !== 'All') result = result.filter(item => item.swStatus === selectedSwStatus);
                    if (searchQuery) {
                        const q = searchQuery.toLowerCase();
                        result = result.filter(item => 
                            (item.Hostname && item.Hostname.toLowerCase().includes(q)) ||
                            (item.SerialNumber && item.SerialNumber.toLowerCase().includes(q)) ||
                            (item['Part Number'] && item['Part Number'].toLowerCase().includes(q)) ||
                            (item['Project Name'] && item['Project Name'].toLowerCase().includes(q))
                        );
                    }
                    setFilteredData(result);
                }, [rawData, selectedVendor, selectedProductType, selectedHwStatus, selectedSwStatus, searchQuery]);

                const handleFileUpload = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    setLoading(true);
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const text = e.target.result;
                        const data = parseCSV(text);
                        const processed = processData(data);
                        setRawData(processed);
                        setLoading(false);
                    };
                    reader.readAsText(file);
                };

                const handleDownloadTemplate = () => {
                    const blob = new Blob([TEMPLATE_HEADERS], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'eol_template.csv';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                };

                const handleClearData = () => {
                    setRawData([]); setFilteredData([]);
                    setSelectedVendor('All'); setSelectedProductType('All');
                    setSelectedHwStatus('All'); setSelectedSwStatus('All');
                    setSearchQuery('');
                };

                const stats = useMemo(() => {
                    const total = filteredData.length;
                    return { total };
                }, [filteredData]);

                const yearData = useMemo(() => {
                    const years = {};
                    filteredData.forEach(d => {
                        if (d.hwDateObj) {
                            const y = d.hwDateObj.getFullYear();
                            if (!years[y]) years[y] = { name: y, HW: 0, SW: 0 };
                            years[y].HW += 1;
                        }
                        if (d.swDateObj) {
                            const y = d.swDateObj.getFullYear();
                            if (!years[y]) years[y] = { name: y, HW: 0, SW: 0 };
                            years[y].SW += 1;
                        }
                    });
                    return Object.values(years).sort((a, b) => a.name - b.name);
                }, [filteredData]);

                const hwStatusDist = useMemo(() => {
                    const counts = { Expired: 0, Critical: 0, Warning: 0, Watchlist: 0, Good: 0, Unknown: 0 };
                    filteredData.forEach(d => counts[d.hwStatus]++);
                    return Object.keys(counts).map(key => ({ name: STATUS_LABELS[key], value: counts[key], key }));
                }, [filteredData]);

                const swStatusDist = useMemo(() => {
                    const counts = { Expired: 0, Critical: 0, Warning: 0, Watchlist: 0, Good: 0, Unknown: 0 };
                    filteredData.forEach(d => counts[d.swStatus]++);
                    return Object.keys(counts).map(key => ({ name: STATUS_LABELS[key], value: counts[key], key }));
                }, [filteredData]);

                const vendorDist = useMemo(() => {
                    const counts = {};
                    filteredData.forEach(d => counts[d.Vendor] = (counts[d.Vendor] || 0) + 1);
                    return Object.keys(counts).map(key => ({ name: key, value: counts[key] })).sort((a, b) => b.value - a.value).slice(0, 10);
                }, [filteredData]);

                const typeDist = useMemo(() => {
                    const counts = {};
                    filteredData.forEach(d => counts[d['Product Type']] = (counts[d['Product Type']] || 0) + 1);
                    return Object.keys(counts).map(key => ({ name: key, value: counts[key] })).sort((a, b) => b.value - a.value).slice(0, 10);
                }, [filteredData]);
                
                // New: Device Type Distribution
                const deviceTypeDist = useMemo(() => {
                    const counts = {};
                    filteredData.forEach(d => {
                        // Use 'Device Type' column or fallback to 'Unknown'
                        const type = d['Device Type'] || 'Unknown';
                        counts[type] = (counts[type] || 0) + 1;
                    });
                    return Object.keys(counts).map(key => ({ name: key, value: counts[key] })).sort((a, b) => b.value - a.value);
                }, [filteredData]);

                const vendors = ['All', ...new Set(rawData.map(d => d.Vendor).filter(Boolean))];
                const productTypes = ['All', ...new Set(rawData.map(d => d['Product Type']).filter(Boolean))];
                const statusOptions = ['All', 'Expired', 'Critical', 'Warning', 'Watchlist', 'Good', 'Unknown'];

                const renderTable = (data, mode) => (
                    <table className="w-full text-sm text-left">
                        <thead className="bg-slate-50 text-slate-500 font-medium whitespace-nowrap">
                            <tr>
                                <th className="px-4 py-3">Hostname</th>
                                {mode === 'standard' && <th className="px-4 py-3">Project Name</th>}
                                {mode === 'standard' && <th className="px-4 py-3">Vendor</th>}
                                {mode === 'standard' && <th className="px-4 py-3">Model / Type</th>}
                                <th className="px-4 py-3">Part Number</th>
                                {mode === 'standard' && <th className="px-4 py-3">Serial Number</th>}
                                <th className="px-4 py-3">SW Version</th>
                                {(mode === 'standard' || mode === 'hw') && <th className="px-4 py-3">HW EOL</th>}
                                {(mode === 'standard' || mode === 'sw') && <th className="px-4 py-3">SW EOL</th>}
                                {(mode === 'standard' || mode === 'hw') && <th className="px-4 py-3">HW Status</th>}
                                {(mode === 'standard' || mode === 'sw') && <th className="px-4 py-3">SW Status</th>}
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100 whitespace-nowrap">
                            {data.map((item) => (
                                <tr key={item.id} className="hover:bg-slate-50 transition-colors">
                                    <td className="px-4 py-3 font-medium text-slate-700">{item.Hostname}</td>
                                    {mode === 'standard' && <td className="px-4 py-3 text-slate-600 max-w-[200px] truncate" title={item['Project Name']}>{item['Project Name']}</td>}
                                    {mode === 'standard' && <td className="px-4 py-3 text-slate-800">{item.Vendor}</td>}
                                    {mode === 'standard' && <td className="px-4 py-3 text-slate-600">{item['Product Type']}</td>}
                                    <td className="px-4 py-3 font-mono text-slate-600">{item['Part Number']}</td>
                                    {mode === 'standard' && <td className="px-4 py-3 font-mono text-slate-500">{item.SerialNumber}</td>}
                                    <td className="px-4 py-3 font-mono text-slate-600">{item['Version']}</td>
                                    
                                    {(mode === 'standard' || mode === 'hw') && (
                                        <td className="px-4 py-3"><div className="flex items-center gap-2">{item['HW EOL Date']}</div></td>
                                    )}
                                    
                                    {(mode === 'standard' || mode === 'sw') && <td className="px-4 py-3">{item['SW EOL Date']}</td>}
                                    
                                    {(mode === 'standard' || mode === 'hw') && (
                                        <td className="px-4 py-3"><StatusBadge status={item.hwStatus} type="HW" /></td>
                                    )}
                                    
                                    {(mode === 'standard' || mode === 'sw') && (
                                        <td className="px-4 py-3"><StatusBadge status={item.swStatus} type="SW" /></td>
                                    )}
                                </tr>
                            ))}
                        </tbody>
                    </table>
                );

                if (rawData.length === 0) {
                    return (
                        <div className="min-h-screen flex items-center justify-center p-4 bg-slate-50">
                            <div className="bg-white p-10 rounded-2xl shadow-xl border border-slate-100 max-w-xl w-full text-center">
                                <div className="bg-blue-50 p-6 rounded-full w-24 h-24 flex items-center justify-center mx-auto mb-6">
                                    <Icons.FileSpreadsheet className="w-12 h-12 text-blue-600" />
                                </div>
                                <h1 className="text-3xl font-bold text-slate-800 mb-2">IT Asset EOL Dashboard <span className="text-sm font-normal text-slate-400 block mt-1">v2.32</span></h1>
                                <p className="text-slate-500 mb-8 text-lg">
                                    Please upload your hardware/software EOL CSV file to visualize the lifecycle data.
                                </p>
                                <div className="flex flex-col sm:flex-row gap-4 justify-center">
                                    <label className="flex items-center justify-center gap-2 px-8 py-4 bg-blue-600 text-white rounded-xl cursor-pointer hover:bg-blue-700 transition shadow-lg hover:shadow-blue-200 text-lg font-semibold transform hover:-translate-y-1">
                                        <Icons.Upload className="w-6 h-6" /> <span>Import CSV File</span>
                                        <input type="file" accept=".csv" onChange={handleFileUpload} className="hidden" />
                                    </label>
                                    <button onClick={handleDownloadTemplate} className="flex items-center justify-center gap-2 px-8 py-4 bg-white text-slate-700 border-2 border-slate-200 rounded-xl hover:bg-slate-50 hover:border-blue-200 hover:text-blue-600 transition text-lg font-semibold transform hover:-translate-y-1">
                                        <Icons.FileDown className="w-6 h-6" /> <span>Get Template</span>
                                    </button>
                                </div>
                                <p className="mt-8 text-sm text-slate-400">Required Columns: Vendor, Hostname, SerialNumber, HW EOL Date, SW EOL Date</p>
                            </div>
                        </div>
                    );
                }

                return (
                    <div className="min-h-screen">
                        {/* Header (Sticky z-30) */}
                        <div className="bg-white shadow-sm sticky top-0 z-30">
                            <div className="w-full px-6 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
                                <div className="flex items-center gap-2">
                                    <Icons.LayoutDashboard className="text-blue-600 w-8 h-8" />
                                    <div>
                                        <h1 className="text-xl font-bold text-slate-800">IT Asset EOL Dashboard</h1>
                                        <p className="text-sm text-slate-500">Hardware & Software Lifecycle Monitor</p>
                                    </div>
                                </div>
                                <div className="flex items-center gap-3">
                                    <button onClick={handleDownloadTemplate} className="flex items-center gap-2 px-3 py-2 text-slate-600 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 hover:text-blue-600 transition shadow-sm text-sm font-medium">
                                        <Icons.FileDown className="w-4 h-4" /> <span className="hidden sm:inline">Template</span>
                                    </button>
                                    <label className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg cursor-pointer hover:bg-blue-700 transition shadow-sm text-sm font-medium">
                                        <Icons.Upload className="w-4 h-4" /> <span>Import CSV</span>
                                        <input type="file" accept=".csv" onChange={handleFileUpload} className="hidden" />
                                    </label>
                                    <button onClick={handleClearData} className="p-2 text-slate-500 hover:text-red-600 hover:bg-red-50 rounded-full" title="Clear Data">
                                        <Icons.Trash2 className="w-5 h-5" />
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div className="w-full px-6 py-6 space-y-6">

                            {/* Filters (Moved Up) */}
                            <div className="sticky sticky-filter z-20 bg-white p-4 rounded-xl shadow-md border border-slate-100 flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between transition-all">
                                <div className="flex flex-wrap gap-4 w-full lg:w-auto">
                                    {[
                                        { label: 'Vendor', val: selectedVendor, set: setSelectedVendor, opts: vendors, icon: Icons.Filter },
                                        { label: 'Product Type', val: selectedProductType, set: setSelectedProductType, opts: productTypes, icon: Icons.Box },
                                        { label: 'Hardware Status', val: selectedHwStatus, set: setSelectedHwStatus, opts: statusOptions, icon: Icons.HardDrive, isStatus: true },
                                        { label: 'Software Status', val: selectedSwStatus, set: setSelectedSwStatus, opts: statusOptions, icon: Icons.Layers, isStatus: true }
                                    ].map((f, i) => (
                                        <div key={i} className="flex flex-col gap-1 w-[180px]">
                                            <span className="text-xs font-semibold text-slate-500 ml-1">{f.label}</span>
                                            <div className="flex items-center gap-2 bg-slate-50 border border-slate-200 rounded-md px-2">
                                                <f.icon className="w-4 h-4 text-slate-400 shrink-0" />
                                                <select className="w-full bg-transparent py-2 text-sm focus:outline-none" value={f.val} onChange={e => f.set(e.target.value)}>
                                                    {f.isStatus ? (
                                                        <>
                                                            <option value="All">All Statuses</option>
                                                            {f.opts.slice(1).map(s => <option key={s} value={s}>{STATUS_LABELS[s]}</option>)}
                                                        </>
                                                    ) : (
                                                        f.opts.map(v => <option key={v} value={v}>{v === 'All' ? `All ${f.label}s` : v}</option>)
                                                    )}
                                                </select>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <div className="relative w-full lg:w-72 mt-4 lg:mt-0">
                                    <Icons.Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-4 h-4" />
                                    <input type="text" placeholder="Search Hostname, Project..." className="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" value={searchQuery} onChange={e => setSearchQuery(e.target.value)} />
                                </div>
                            </div>
                            
                            {/* Layout: Top Row (Status + Trend) */}
                            <div className="grid grid-cols-1 xl:grid-cols-3 gap-6">
                                {/* Left Column: Status Overview (Span 2/3) */}
                                <div className="xl:col-span-2 bg-white rounded-xl shadow-sm border border-slate-100 p-6 h-full">
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                                            <Icons.LayoutDashboard className="w-5 h-5 text-blue-500" />
                                            <span>Status Overview</span>
                                        </h2>
                                        <div className="bg-blue-50 text-blue-700 px-4 py-2 rounded-lg font-bold text-sm">
                                            Total Devices: {stats.total}
                                        </div>
                                    </div>
                                    
                                    {/* Hardware EOL */}
                                    <div className="mb-6">
                                        <h3 className="text-sm font-semibold text-slate-500 mb-3 flex items-center gap-2">
                                            <Icons.HardDrive className="w-4 h-4" /> Hardware EOL Status
                                        </h3>
                                        <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3">
                                            {STATUS_ORDER.map(statusKey => {
                                                const item = hwStatusDist.find(d => d.key === statusKey) || { value: 0 };
                                                return (
                                                    <StatusBox 
                                                        key={statusKey} 
                                                        label={STATUS_LABELS[statusKey]} 
                                                        count={item.value} 
                                                        config={STATUS_CONFIG[statusKey]}
                                                    />
                                                );
                                            })}
                                        </div>
                                    </div>

                                    {/* Software EOL */}
                                    <div>
                                        <h3 className="text-sm font-semibold text-slate-500 mb-3 flex items-center gap-2">
                                            <Icons.Layers className="w-4 h-4" /> Software EOL Status
                                        </h3>
                                        <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3">
                                            {STATUS_ORDER.map(statusKey => {
                                                const item = swStatusDist.find(d => d.key === statusKey) || { value: 0 };
                                                return (
                                                    <StatusBox 
                                                        key={statusKey} 
                                                        label={STATUS_LABELS[statusKey]} 
                                                        count={item.value} 
                                                        config={STATUS_CONFIG[statusKey]}
                                                    />
                                                );
                                            })}
                                        </div>
                                    </div>
                                </div>

                                {/* Right Column: Annual EOL Trend (Span 1/3) */}
                                <div className="xl:col-span-1 bg-white p-6 rounded-xl shadow-sm border border-slate-100 h-full flex flex-col">
                                    <h3 className="text-lg font-semibold text-slate-800 mb-4 flex items-center gap-2 flex-shrink-0">
                                        <Icons.Clock className="w-5 h-5 text-blue-500" /> Annual EOL Trend
                                    </h3>
                                    <div className="flex-grow min-h-[300px]">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <BarChart data={yearData} margin={{ top: 20, right: 30, left: 0, bottom: 5 }}>
                                                <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                                <XAxis dataKey="name" tick={{fontSize: 12}} />
                                                <YAxis tick={{fontSize: 12}} />
                                                <RechartsTooltip contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }} />
                                                <Legend wrapperStyle={{fontSize: '12px'}} />
                                                <Bar dataKey="HW" name="HW" fill="#3B82F6" radius={[4, 4, 0, 0]} label={renderBarLabelTop} />
                                                <Bar dataKey="SW" name="SW" fill="#8B5CF6" radius={[4, 4, 0, 0]} label={renderBarLabelTop} />
                                            </BarChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>
                            </div>

                            {/* Secondary Charts Row: 3 Columns - All Pie Charts Now */}
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                {/* Vendor Distribution (Pie) */}
                                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 h-[400px]">
                                    <h3 className="text-lg font-semibold text-slate-800 mb-4 flex items-center gap-2"><Icons.Filter className="w-5 h-5 text-purple-500" /> Vendor</h3>
                                    <div className="h-[340px]">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <PieChart margin={{ top: 20, right: 30, left: 30, bottom: 50 }}>
                                                <Pie
                                                    data={vendorDist}
                                                    cx="50%"
                                                    cy="50%"
                                                    innerRadius={40}
                                                    outerRadius={75}
                                                    paddingAngle={5}
                                                    dataKey="value"
                                                    label={renderPieLabel}
                                                >
                                                    {vendorDist.map((entry, index) => (
                                                        <Cell key={`cell-${index}`} fill={PIE_COLORS[index % PIE_COLORS.length]} />
                                                    ))}
                                                </Pie>
                                                <RechartsTooltip />
                                                <Legend wrapperStyle={{fontSize: '11px', bottom: '0px'}} verticalAlign="bottom" height={36}/>
                                            </PieChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>

                                {/* Product Types (Pie) */}
                                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 h-[400px]">
                                    <h3 className="text-lg font-semibold text-slate-800 mb-4 flex items-center gap-2"><Icons.Box className="w-5 h-5 text-green-500" /> Product</h3>
                                    <div className="h-[340px]">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <PieChart margin={{ top: 20, right: 30, left: 30, bottom: 50 }}>
                                                <Pie
                                                    data={typeDist}
                                                    cx="50%"
                                                    cy="50%"
                                                    innerRadius={40}
                                                    outerRadius={75}
                                                    paddingAngle={5}
                                                    dataKey="value"
                                                    label={renderPieLabel}
                                                >
                                                    {typeDist.map((entry, index) => (
                                                        <Cell key={`cell-${index}`} fill={PIE_COLORS[index % PIE_COLORS.length]} />
                                                    ))}
                                                </Pie>
                                                <RechartsTooltip />
                                                <Legend wrapperStyle={{fontSize: '11px', bottom: '0px'}} verticalAlign="bottom" height={36}/>
                                            </PieChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>

                                {/* Device Type (Pie) - Replaced Project Distribution */}
                                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 h-[400px]">
                                    <h3 className="text-lg font-semibold text-slate-800 mb-4 flex items-center gap-2"><Icons.Briefcase className="w-5 h-5 text-teal-500" /> Device Type</h3>
                                    <div className="h-[340px]">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <PieChart margin={{ top: 20, right: 30, left: 30, bottom: 50 }}>
                                                <Pie
                                                    data={deviceTypeDist}
                                                    cx="50%"
                                                    cy="50%"
                                                    innerRadius={40}
                                                    outerRadius={75}
                                                    paddingAngle={5}
                                                    dataKey="value"
                                                    label={renderPieLabel}
                                                >
                                                    {deviceTypeDist.map((entry, index) => (
                                                        <Cell key={`cell-${index}`} fill={PIE_COLORS[index % PIE_COLORS.length]} />
                                                    ))}
                                                </Pie>
                                                <RechartsTooltip />
                                                <Legend wrapperStyle={{fontSize: '11px', bottom: '0px'}} verticalAlign="bottom" height={36}/>
                                            </PieChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Device List Table */}
                            <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                                <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                                    <div className="flex items-center gap-3">
                                        <h3 className="font-semibold text-slate-800">Device List</h3>
                                        <span className="text-xs bg-slate-100 text-slate-500 px-2 py-1 rounded-full">{filteredData.length} Items</span>
                                    </div>
                                    <div className="flex bg-slate-100 rounded-lg p-1 gap-1">
                                        <button 
                                            onClick={() => setViewMode('standard')} 
                                            className={`flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-medium transition ${viewMode === 'standard' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                                            title="Standard View (Single Column)"
                                        >
                                            <Icons.List className="w-4 h-4" /> <span className="hidden sm:inline">Standard</span>
                                        </button>
                                        <button 
                                            onClick={() => setViewMode('hw')} 
                                            className={`flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-medium transition ${viewMode === 'hw' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                                            title="Hardware Focus (Split View)"
                                        >
                                            <Icons.Grid className="w-4 h-4" /> <span className="hidden sm:inline">HW EOL</span>
                                        </button>
                                        <button 
                                            onClick={() => setViewMode('sw')} 
                                            className={`flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-medium transition ${viewMode === 'sw' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                                            title="Software Focus (Split View)"
                                        >
                                            <Icons.Grid className="w-4 h-4" /> <span className="hidden sm:inline">SW EOL</span>
                                        </button>
                                    </div>
                                </div>
                                <div className="overflow-x-auto p-4">
                                    {viewMode === 'standard' ? (
                                        renderTable(filteredData.slice(0, 100), 'standard')
                                    ) : (
                                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                            <div className="bg-white rounded-lg border border-slate-200 overflow-hidden">
                                                {renderTable(filteredData.slice(0, Math.ceil(filteredData.length / 2)), viewMode)}
                                            </div>
                                            <div className="bg-white rounded-lg border border-slate-200 overflow-hidden">
                                                {renderTable(filteredData.slice(Math.ceil(filteredData.length / 2)), viewMode)}
                                            </div>
                                        </div>
                                    )}
                                    {filteredData.length > 100 && viewMode === 'standard' && (
                                        <div className="p-4 text-center text-slate-500 text-sm border-t border-slate-100 bg-slate-50">
                                            Showing first 100 items. Please use filters to find specific devices.
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            const root = createRoot(document.getElementById('root'));
            root.render(<EOLDashboard />);
        } catch (err) {
            console.error(err);
            document.getElementById('error-box').style.display = 'flex';
            document.getElementById('error-message').textContent = err.toString();
            document.getElementById('root').style.display = 'none';
        }
    </script>
</body>
</html>